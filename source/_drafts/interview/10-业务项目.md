
## jsBridge 

jsbridge 就是native和非native之间的桥梁，它的核心是构建Native和非Native间消息通信的通道，而且是双向通信的通道。


* JS向Native发送消息： 调用相关功能，通知Native当前JS的相关状态
* Native向JS发送消息： 回溯调用结果、消息推送、通知JS当前Native的状态

### jsBridge 实现原理

#### js调用native


* 1.注入API对象

> 通过webview提供的接口，向javaScript的context（Window）中注入对象和方法，当js调用时，直接执行相应的Native代码逻辑，达到js调用Native的效果。

>不过在android 4.2之前，Android注入js对象的接口addJavascriptInterface，有漏洞，存在安全问题。4.2之后提供新的@JavascriptInterface来代替这个接口，解决安全问题

* 2.拦截window的confirm、alert

* 3.拦截URL SCHEME

> URL SCHEME是一种类似于url的链接，是为了方便app直接互相调用设计的，形式和普通的 url 近似，主要区别是 protocol 和 host 一般是自定义的，例如: qunarhy://hy/url?url=ymfe.tech，protocol 是 qunarhy，host 则是 hy。

> Web 端通过某种方式（例如 iframe.src）发送 URL Scheme 请求，之后 Native 拦截到请求并根据 URL SCHEME（包括所带的参数）进行相关操作。

> 缺点：使用 iframe.src 发送 URL SCHEME 会有 url 长度的隐患； 创建请求，需要一定的耗时；但是支持ios6。

> 【注】：有些方案为了规避 url 长度隐患的缺陷，在 iOS 上采用了使用 Ajax 发送同域请求的方式，并将参数放到 head 或 body 里。这样，虽然规避了 url 长度的隐患，但是 WKWebView 并不支持这样的方式。

> 【注2】：为什么选择 iframe.src 不选择 locaiton.href ？因为如果通过 location.href 连续调用 Native，很容易丢失一些调用。


#### native 调用JS

Native 调用 JavaScript，其实就是执行拼接 JavaScript 字符串，从外部调用 JavaScript 中的方法，因此 JavaScript 的方法必须在全局的 window 上。

* ios: 调用 `stringByEvaluatingJavaScriptFromString` 执行一段js脚本，并且返回执行结果 
* android： 对于 Android，在 Kitkat（4.4）之前并没有提供 iOS 类似的调用方式，只能用loadUrl 一段 JavaScript 代码，来实现(不能获取执行后的结果)：`webView.loadUrl("javascript:" + javaScriptString);`而 Kitkat 之后的版本，也可以用 evaluateJavascript 方法实现

## 性能优化

### 全站性能优化方案

1. 去除gio短链重定向方案，避免站内重定向
2. 图片懒加载
3. 统一全站定位逻辑
4. 修改http1.1 协议为 http 2.0
5. 使用不同域名还可以隔离cookie
6. 图标使用iconfont，小图片使用内嵌方式，webpack 转为 base64
7. 服务器开启gzip压缩传输方式

### 教练端性能优化方法

1. 梳理项目代码，删减无用重复CSS代码，整理外部引用的库文件（vux、moment、lodash），减少包文件大小
2. 修改外部依赖文件的引用方式、如七鱼sdk、高德sdk
3. 替换页面原有路由方式，使用路由懒加载
4. 封装七牛cdn图片压缩和webp方法，使用vue过滤器，对前端使用的图片链接做针对性裁剪和压缩
5. 对比较慢的页面做针对性优化：1. node聚合前端多个接口请求；2. 对接口未返回的页面，添加默认数据不至于刚开始是白屏 3. 分页加载数据
6. 打开DNS预读取功能，在html上添加 `<meta http-equiv="x-dns-prefetch-control" content="off">`, 或者使用link，强制查询特定域名：`<link rel="dns-prefetch" href="//www.leoao.com/">`
7. 离线包方案

### 使用cdn

1. 设置不同域名，增加请求的并发量
2. 覆盖全国节点，根据用户的运营商服务，访问最近的服务器，加载访问速度
3. 保障网站安全，CDN的负载均衡和分布式存储技术，可以加强网站的可靠性

### gzip是什么

[详细介绍](https://segmentfault.com/a/1190000012800222)

相当于给同事发文件时，把文件压缩后再发给对方，对方再根据文件格式对文件进行解压使用。

服务器通过在http请求中添加content-encoding属性，来说明数据需要哪种压缩方法

```
Content-Encoding: gzip
Content-Encoding: compress
Content-Encoding: deflate
```

客户端页可以通过在请求头中带上，accept-Encoding 来说明自己接受哪种压缩方法

```
Accept-Encoding: gzip, deflate
```

![](http://cdn.chuyunt.com/picGo/gzip.png?imageslim)

### dns解析过程

1. 在浏览器输入域名地址，然后系统会去查询本地hosts文件，是否有对应的域名映射，有的话就完成域名解析
2. 没有的话，系统会询问本地DNS服务器，是否能找到对应的ip地址，有的话就完成域名解析
3. 如果本地的DNS服务解析失败没有查询到，则会开始向上级DNS服务器查询
4. 本地dns服务器（有运营商提供） <=> 根域  <=> 一级域(.com) <=> 二级域(163.com)

![](http://cdn.chuyunt.com/picGo/DNS.png?imageslim)
![](http://cdn.chuyunt.com/picGo/DNS递归查询.png?imageslim)

### 白屏的主要原因

1. webview初始化
2. 和服务器建立连接，请求HTML，下载资源
3. css解析渲染
4. js代码解析执行
5. 请求接口数据


