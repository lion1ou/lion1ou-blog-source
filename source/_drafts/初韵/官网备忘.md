* # 项目备忘

  ## 连接服务器

  ```
  @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
  @    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @
  @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
  IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!
  Someone could be eavesdropping on you right now (man-in-the-middle attack)!
  It is also possible that a host key has just been changed.
  The fingerprint for the ECDSA key sent by the remote host is
  SHA256:Qkz9Hzy3HJfIsp3M1hjUkLYsdhbB5DEFI/DmJbRgjo8.
  Please contact your system administrator.
  Add correct host key in /Users/lionluo/.ssh/known_hosts to get rid of this message.
  Offending ECDSA key in /Users/lionluo/.ssh/known_hosts:5
  ECDSA host key for 47.100.99.159 has changed and you have requested strict checking.
  Host key verification failed.
  ```
  https://www.cnblogs.com/johnchain/archive/2013/04/08/3006631.html
  
* 解决方案：

  删除~/.ssh/known_hosts文件，或者如果你可以判断出known_hosts中原ssh服务器的公钥，删去那部分，

  然后后再次建立新的连接，即可获得新的公钥


  服务器远程访问帐号密码：

  ```
  root    
  a7677188.
  ```

  ssh root@47.100.99.159

### linux文件目录

/bin:是binary的缩写,这个目录是对Unix系统习惯的沿袭,存放着使用者最经常使用的命令。如:ls,cp,cat等。

/boot:这里存放的是启动Linux时使用的一些核心文件。

/dev:是device的缩写.这个目录下是所有Linux的外部设备,其功能类似Dos下的.sys和Win下的.vxd。

/etc:这个目录用来存放所有的系统管理所需要的配置文件和子目录。

/home:用户主目录,比如说有个用户叫sina,那他的主目录就是/home/sina

/lib:这个目录里存放着系统最基本的动态链接共享库,其作用类似于Windows里的.dll文件。几乎所有的应用程序都需要用到这些共享库。

/lost+found:这个目录平时是空的,当系统不正常关机后,这里就成了一些无家可归的文件的避难所。

/mnt:这个目录是空的,系统提供这个目录是让用户临时挂载别的文件系统。

/proc:这个目录是一个虚拟的目录,它是系统内存的映射,我们可以通过直接访问这个目录来获取系统信息。

/root:系统管理员,也叫超级权限者的用户主目录。当然系统的拥有者,总要有些特权啊。

/sbin:s就是Super User的意思,也就是说这里存放的是一些系统管理员使用的系统管理程序。

/tmp:这个目录不用说,一定是用来存放一些临时文件的地方了。

/usr:这是个最庞大的目录,我们要用到的很多应用程序和文件几乎都存放在这个目录了。具体来说:
/usr/X11R6:存放X-Windows的目录。
/usr/bin:存放着许多应用程序.
/usr/sbin:给超级用户使用的一些管理程序就放在这.
/usr/doc:这就是Linux文档的大本营.
/usr/include:Linux下开发和编译应用程序需要的头文件在这里找.
/usr/lib:存放一些常用的动态链接共享库和静态档案库.
/usr/local:这是提供给一般用户的/usr目录,在这安装软件最适合.
/usr/man:是帮助文档目录.
/usr/src:Linux开放的源代码,就存在这个目录,爱好者们别放过哦!

/var:这个目录中存放着那些不断在扩充着的东西,为了保持/usr的相对稳定,那些经常被修改的目录可以放在这个目录下,实际上许多系统管理员都是这样干的.顺便说一下,系统的日志文件就在/var/log目录中.



**所以还是把东西都放在var吧**



### 安装环境

1. 安装node： 

   1. 下载node：wget https://nodejs.org/dist/v8.12.0/node-v8.12.0-linux-x64.tar.xz
   2. 解压xz：xz -d node-v10.15.1-linux-x64.tar.xz 
   3. 解压tar：tar -xvf node-v10.15.1-linux-x64.tar 
   4. 建立npm软链：ln -s /var/node-v10.15.1-linux-x64/bin/npm /usr/local/bin
   5. 建立node软链：ln -s /var/node-v10.15.1-linux-x64/bin/node /usr/local/bin
   6. 检查安装成功：node -v   &&  npm -v、
   7. 安装路径： /var/node-v10.15.1-linux-x64

   

2. 安装git：

   ```bash
   yum install git
   ```

3.  安装mongoDB      https://www.codercto.com/a/16954.html

   * 安装路径： /bin/mongo （全局命令）
   * sudo service mongod start
   * 配置文件路径： /etc/mongod.conf

4. mongo 设置密码   https://juejin.im/post/5b0519cf518825426539d05e

   * 创建账户：db.createUser({ user: "admin", pwd: "a7677188.", roles: [{ role: "root", db: "admin" }] })
   * 每个数据都需要单独创建一下账户，创建数据库：db.createUser({ user: "chuyun", pwd: "chuyun123", roles: [{ role: "dbOwner", db:"cykoa2" }] })
   * node连接数据库，登录需要验证账号密码。没有验证，也可以正常登录，但是没办法进行操作。

5. 查看mongo运行状态

   1. netstat -lanp | grep "27017"  # 返回为两条数据
   2. sudo service mongod stop  && netstat -lanp | grep "27017"  # 返回为空
   3. sudo service mongod start  && netstat -lanp | grep "27017"  # 返回为两条数据

6. mongo连接不了，报MongoNetworkError

   修改 /etc/mongodb.conf

   ```
   net:
      bindIp: 0.0.0.0   # 一般不建议这样配置bindIp,单纯debug
      port: 27017
   ```

7. git clone 项目
8. 安装nginx
      
      yum install -y nginx
    
    配置 nginx
      
      /etc/nginx/nginx.conf

9. 安装pm2

  ```bash
  npm install -g pm2
  ln -s /var/node-v10.15.1-linux-x64/bin/pm2 /usr/local/bin
  ```

10. 备份数据库

https://segmentfault.com/a/1190000009937244

  ## 项目简介

  1. cy_nuxt 是初韵的官网，使用Nuxt.js实现，有利于SEO，项目地址：https://github.com/lion1ou/cy_nuxt.git
  2. cy_admin  是管理后台，是在antd pro基础上进行搭建，项目地址： https://github.com/lion1ou/cy_admin.git
  3. cy_koa 提供网站后台接口 https://github.com/lion1ou/cy_koa.git

  

  ## 发布方式

  * cy_nuxt
  ```
  cd /var/www/cy_koa
  git pull
  npm run build
  pm2 restart cy_nuxt
  ```

  * cy_admin

  ```
  本地打包
  上传服务器
  解压
  ```

  * cy_koa
  ```
  git pull
  pm2 restart cy_koa2
  ```


  ## 服务器nginx配置文件目录

  ```shell
  /www/server/panel/vhost/nginx
  
  vi /www/server/panel/vhost/nginx/node_service.conf
  ```


  ```shell
  server {
      server_name  www.chuyunt.com;
      location /{
          proxy_redirect off;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_pass http://127.0.0.1:3000;
       }
       location /proxy/ {
          proxy_pass http://127.0.0.1:3001/;
       }
  }

  server {
      listen       80;
      server_name  admin.chuyunt.com;

      location / {
          root   /root/cy_admin/dist; # 静态文件地址
          try_files $uri $uri/ /index.html;
          index  index.html index.htm; # 指定首页
      }
      location /proxy/ {
          proxy_pass http://127.0.0.1:3001/;
      }
  }
  server {
      listen       80;
      server_name  old.chuyunt.com;

      location / {
          root   /root/website/dist; # 静态文件地址
          try_files $uri $uri/ /index.html;
          index  index.html index.htm; # 指定首页
      }
  }
  ```

  ## 阿里云nginx配置


  * 查看进程：ps -ef | grep {过滤项}
  * 杀掉进程：kill -9 {进程号}
  * nginx 配置文件：

  ```shell
  vi /etc/nginx/conf.d/nginx-self.conf
  ```

  * 查看服务状态：
  ```shell
  systemctl status nginx.service
  systemctl start nginx.service
  systemctl restart nginx.service
  ```

  ```shell
  server { # 官网首页
      listen       80;
      server_name  www.fdshfccy.com fdshfccy.com;
  
      location / {
          root   /home/chuyun-web/dist; # 静态文件地址
          index  index.html index.htm; # 指定首页
      }
  }
  ```


  ### nuxt 部署

  * 官方推荐部署方式

  关于服务端渲染应用部署，官方文档是这么写的：

  部署 Nuxt.js 服务端渲染的应用不能直接使用 nuxt 命令，而应该先进行编译构建，然后再启动 Nuxt 服务，可通过以下两个命令来完成：
  ```
  nuxt build
  nuxt start
  ```
  推荐的 package.json 配置如下：
  ```
  {
    "name": "my-app",
    "dependencies": {
      "nuxt": "latest"
    },
    "scripts": {
      "dev": "nuxt",
      "build": "nuxt build",
      "start": "nuxt starcd t"
    }
  }
  ```
  提示： 建议将 .nuxt 加入 .npmignore 和 .gitignore 文件中。
  意思是说.nuxt不加入到版本控制，每次服务器从gitlab上拉代码后先执行nuxt build生成.nuxt文件夹，然后再执行nuxt start来启动服务。

  * 踩过的坑

  部署方式很简单对不对，看完文档后我就在自己买的服务器上尝试部署一下，然后，BOOM！！！
  每次在服务器上执行nuxt build，总是有如下报错，并且jenkins会随之挂掉。
  error Command failed with signal "SIGKILL".

  看了一下服务器监控发现build的时候cpu和内存飙升，尤其是内存。。。
  好吧，我买的是阿里最低配的ECS，升级配置是最后的选择，在这之前只能另辟蹊径。

  * 另辟蹊径

  既然服务器上build不了，那我们就本地build再上传，在.gitignore里把.nuxt去掉、并把dist改为/dist，然后本地执行yarn build，成功之后再上传到github上，检查一下.nuxt是否有上传上去。
  之后在服务器上把代码拉下来、安装一下依赖，执行nuxt start就可以了。
  这里还有个坑，就是为什么要把.gitignore里的dist改为/dist？
  /dist这个文件夹是执行nuxt generate后生成的，用来做静态应用部署的，这部分就跟通常情况下的.nuxt一样是不应该加入到版本控制里的，但由于nuxt build之后，在.nuxt里也会生成一个dist文件夹，我们希望gitignore的只有/dist而不是/.nuxt/dist，因此猜需要做出这里的修改。

  * nuxt部署

  最后，我们使用pm2来部署nuxt。

  pm2 start npm --name 'cy_nuxt' -- run start


  ### 二期新需求

  * 后台登录密码没有加密
  * node爬虫爬取最新的茶叶文章
  * 留言需要加验证码
  * 添加评价模块
  * 添加日期组件
  * 添加文章列表边上的热门文章
  * 提供一个二维码跳转页面，统一控制二维码搜集数据`
  * 

  mongodb

  db.createUser({ user: "lion1ou", pwd: "lion1ou", roles: [{ role: "userAdminAnyDatabase", db: "admin" }] })

db.createUser({user: 'admin',pwd: 'a7677188.',roles: [{role: 'root', db: 'admin'}]})