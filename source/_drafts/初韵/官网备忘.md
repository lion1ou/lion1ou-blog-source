# 项目备忘

## 连接服务器

服务器远程访问帐号密码：

```
root   a7677188.
```

ssh root@47.100.99.159



## 项目简介

1. cy_nuxt 是初韵的官网，使用Nuxt.js实现，有利于SEO，项目地址：https://github.com/lion1ou/cy_nuxt.git
2. cy_admin  是管理后台，是在antd pro基础上进行搭建，项目地址： https://github.com/lion1ou/cy_admin.git
3. cy_koa 提供网站后台接口 https://github.com/lion1ou/cy_koa.git



## 发布方式

* cy_nuxt

```shell
cd /var/www/cy_nuxt
git pull
npm i
npm run build
pm2 restart nuxt
# pm2 start npm --name 'nuxt' -- run start
```

* cy_admin

```shell 
cd /var/www/cy_admin
git pull
npm i
npm run build
```

* cy_koa

```shell
cd /var/www/cy_koa
git pull
npm i
pm2 restart koa2
# pm2 start app.js --name 'koa2'
```


## 服务器nginx配置文件目录

* 查看进程：ps -ef | grep {过滤项}
* 杀掉进程：kill -9 {进程号}

```shell
cd /usr/local/nginx

vi /usr/local/nginx/conf/nginx.conf # 编辑配置文件

/usr/local/nginx/sbin/nginx -t # 测试配置文件是否正确

/usr/local/nginx/sbin/nginx -s reload # 重启 nginx
```


```shell
server {
    server_name  www.chuyunt.com;
    location /{
        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass http://127.0.0.1:3000;
     }
     location /proxy/ {
        proxy_pass http://127.0.0.1:3001/;
     }
}

server {
    listen       80;
    server_name  admin.chuyunt.com;

    location / {
        root   /var/www/cy_admin/dist; # 静态文件地址
        try_files $uri $uri/ /index.html;
        index  index.html index.htm; # 指定首页
    }
    location /proxy/ {
        proxy_pass http://127.0.0.1:3001/;
    }
}
server {
    listen       80;
    server_name  old.chuyunt.com;

    location / {
        root   /var/www/website/dist; # 静态文件地址
        try_files $uri $uri/ /index.html;
        index  index.html index.htm; # 指定首页
    }
}
```


### nuxt 部署

* 官方推荐部署方式

关于服务端渲染应用部署，官方文档是这么写的：

部署 Nuxt.js 服务端渲染的应用不能直接使用 nuxt 命令，而应该先进行编译构建，然后再启动 Nuxt 服务，可通过以下两个命令来完成：
```
nuxt build
nuxt start
```
推荐的 package.json 配置如下：
```
{
  "name": "my-app",
  "dependencies": {
    "nuxt": "latest"
  },
  "scripts": {
    "dev": "nuxt",
    "build": "nuxt build",
    "start": "nuxt start"
  }
}
```
提示： 建议将 .nuxt 加入 .npmignore 和 .gitignore 文件中。
意思是说.nuxt不加入到版本控制，每次服务器从gitlab上拉代码后先执行nuxt build生成.nuxt文件夹，然后再执行nuxt start来启动服务。

* 踩过的坑

部署方式很简单对不对，看完文档后我就在自己买的服务器上尝试部署一下，然后，BOOM！！！
每次在服务器上执行nuxt build，总是有如下报错，并且jenkins会随之挂掉。
error Command failed with signal "SIGKILL".

看了一下服务器监控发现build的时候cpu和内存飙升，尤其是内存。。。
好吧，我买的是阿里最低配的ECS，升级配置是最后的选择，在这之前只能另辟蹊径。

* 另辟蹊径

既然服务器上build不了，那我们就本地build再上传，在.gitignore里把.nuxt去掉、并把dist改为/dist，然后本地执行yarn build，成功之后再上传到github上，检查一下.nuxt是否有上传上去。
之后在服务器上把代码拉下来、安装一下依赖，执行nuxt start就可以了。
这里还有个坑，就是为什么要把.gitignore里的dist改为/dist？
/dist这个文件夹是执行nuxt generate后生成的，用来做静态应用部署的，这部分就跟通常情况下的.nuxt一样是不应该加入到版本控制里的，但由于nuxt build之后，在.nuxt里也会生成一个dist文件夹，我们希望gitignore的只有/dist而不是/.nuxt/dist，因此猜需要做出这里的修改。

* nuxt部署

最后，我们使用pm2来部署nuxt。



### 二期新需求

* 数据埋点，记录用户访问量和访问路径
* 后台登录密码没有加密
* node爬虫爬取最新的茶叶文章
* 留言需要加验证码
* 添加评价模块
* 添加日期组件
* 添加文章列表边上的热门文章
* 提供一个二维码跳转页面，统一控制二维码搜集数
